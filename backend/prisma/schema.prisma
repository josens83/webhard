// Prisma Schema for WeDisk Clone

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 사용자 모델
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  username          String    @unique
  password          String?
  displayName       String?
  avatar            String?
  phone             String?
  birthDate         DateTime?
  gender            Gender?

  // OAuth 관련
  provider          AuthProvider @default(LOCAL)
  providerId        String?

  // 계정 상태
  isVerified        Boolean   @default(false)
  isActive          Boolean   @default(true)
  isSeller          Boolean   @default(false)
  isAdmin           Boolean   @default(false)

  // 포인트/캐시 시스템
  cash              Int       @default(0)
  point             Int       @default(0)
  couponCount       Int       @default(0)
  stars             Int       @default(0)

  // 멤버십
  membershipLevel   MembershipLevel @default(FREE)
  membershipExpiry  DateTime?

  // 타임스탬프
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastLoginAt       DateTime?

  // 관계
  uploads           File[]             @relation("UserUploads")
  purchases         Purchase[]
  downloads         Download[]
  comments          Comment[]
  ratings           Rating[]
  favorites         Favorite[]
  coupons           UserCoupon[]
  transactions      Transaction[]
  notifications     Notification[]
  reports           Report[]

  @@index([email])
  @@index([username])
  @@map("users")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AuthProvider {
  LOCAL
  GOOGLE
  KAKAO
  NAVER
  FACEBOOK
}

enum MembershipLevel {
  FREE
  BRONZE
  SILVER
  GOLD
  PLATINUM
  VIP
}

// 카테고리 모델
model Category {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  icon        String?
  description String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)

  // 부모-자식 관계 (서브카테고리)
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  files       File[]

  @@index([slug])
  @@index([parentId])
  @@map("categories")
}

// 파일 모델
model File {
  id              String    @id @default(uuid())
  title           String
  description     String?
  fileName        String
  fileSize        BigInt
  mimeType        String
  fileExtension   String

  // 저장 경로
  storagePath     String
  thumbnailPath   String?
  previewPath     String?

  // 가격 정보
  price           Int       @default(0)  // 0 = 무료
  priceType       PriceType @default(CASH)

  // 통계
  downloadCount   Int       @default(0)
  viewCount       Int       @default(0)
  favoriteCount   Int       @default(0)

  // 평점
  ratingAverage   Float     @default(0)
  ratingCount     Int       @default(0)

  // 상태
  status          FileStatus @default(PENDING)
  isHidden        Boolean   @default(false)
  isFeatured      Boolean   @default(false)
  isAdult         Boolean   @default(false)

  // 업로더 정보
  uploaderId      String
  uploader        User      @relation("UserUploads", fields: [uploaderId], references: [id])

  // 카테고리
  categoryId      String
  category        Category  @relation(fields: [categoryId], references: [id])

  // 태그
  tags            FileTag[]

  // 타임스탬프
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  publishedAt     DateTime?
  deletedAt       DateTime?

  // 관계
  purchases       Purchase[]
  downloads       Download[]
  comments        Comment[]
  ratings         Rating[]
  favorites       Favorite[]
  reports         Report[]

  @@index([uploaderId])
  @@index([categoryId])
  @@index([status])
  @@index([createdAt])
  @@map("files")
}

enum PriceType {
  FREE
  CASH
  POINT
  COUPON
}

enum FileStatus {
  PENDING
  APPROVED
  REJECTED
  DELETED
}

// 태그 모델
model Tag {
  id        String    @id @default(uuid())
  name      String    @unique
  slug      String    @unique
  count     Int       @default(0)
  createdAt DateTime  @default(now())

  files     FileTag[]

  @@index([slug])
  @@map("tags")
}

model FileTag {
  fileId    String
  tagId     String

  file      File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([fileId, tagId])
  @@map("file_tags")
}

// 구매 모델
model Purchase {
  id              String    @id @default(uuid())

  userId          String
  user            User      @relation(fields: [userId], references: [id])

  fileId          String
  file            File      @relation(fields: [fileId], references: [id])

  price           Int
  priceType       PriceType

  // 결제 정보
  paymentMethod   String?
  transactionId   String?

  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([fileId])
  @@index([createdAt])
  @@map("purchases")
}

// 다운로드 기록
model Download {
  id        String   @id @default(uuid())

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  fileId    String
  file      File     @relation(fields: [fileId], references: [id])

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([fileId])
  @@index([createdAt])
  @@map("downloads")
}

// 댓글 모델
model Comment {
  id        String   @id @default(uuid())
  content   String

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  fileId    String
  file      File     @relation(fields: [fileId], references: [id])

  // 대댓글 지원
  parentId  String?
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")

  isDeleted Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([fileId])
  @@index([parentId])
  @@map("comments")
}

// 평점 모델
model Rating {
  id        String   @id @default(uuid())
  rating    Int      // 1-5

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  fileId    String
  file      File     @relation(fields: [fileId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, fileId])
  @@index([fileId])
  @@map("ratings")
}

// 찜하기/북마크
model Favorite {
  id        String   @id @default(uuid())

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  fileId    String
  file      File     @relation(fields: [fileId], references: [id])

  createdAt DateTime @default(now())

  @@unique([userId, fileId])
  @@index([userId])
  @@map("favorites")
}

// 쿠폰 모델
model Coupon {
  id              String      @id @default(uuid())
  code            String      @unique
  name            String
  description     String?

  discountType    DiscountType
  discountValue   Int         // 금액 또는 퍼센트

  minPurchase     Int         @default(0)
  maxDiscount     Int?

  validFrom       DateTime
  validUntil      DateTime

  usageLimit      Int?
  usedCount       Int         @default(0)

  isActive        Boolean     @default(true)

  createdAt       DateTime    @default(now())

  userCoupons     UserCoupon[]

  @@index([code])
  @@map("coupons")
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

model UserCoupon {
  id        String   @id @default(uuid())

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  couponId  String
  coupon    Coupon   @relation(fields: [couponId], references: [id])

  isUsed    Boolean  @default(false)
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([userId])
  @@map("user_coupons")
}

// 거래 내역
model Transaction {
  id              String          @id @default(uuid())

  userId          String
  user            User            @relation(fields: [userId], references: [id])

  type            TransactionType
  amount          Int
  balance         Int             // 거래 후 잔액

  currency        Currency        @default(CASH)

  description     String?

  // PG 관련
  paymentMethod   String?
  pgProvider      String?
  pgTransactionId String?

  status          PaymentStatus   @default(PENDING)

  metadata        Json?

  createdAt       DateTime        @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("transactions")
}

enum TransactionType {
  DEPOSIT          // 입금
  WITHDRAWAL       // 출금
  PURCHASE         // 구매
  REFUND           // 환불
  REWARD           // 보상
  BONUS            // 보너스
  TRANSFER         // 이체
}

enum Currency {
  CASH
  POINT
  COUPON
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

// 알림 모델
model Notification {
  id        String           @id @default(uuid())

  userId    String
  user      User             @relation(fields: [userId], references: [id])

  type      NotificationType
  title     String
  message   String

  link      String?

  isRead    Boolean          @default(false)

  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

enum NotificationType {
  SYSTEM
  PURCHASE
  DOWNLOAD
  COMMENT
  RATING
  PAYMENT
  PROMOTION
}

// 신고 모델
model Report {
  id          String       @id @default(uuid())

  reporterId  String
  reporter    User         @relation(fields: [reporterId], references: [id])

  fileId      String
  file        File         @relation(fields: [fileId], references: [id])

  reason      ReportReason
  description String?

  status      ReportStatus @default(PENDING)

  createdAt   DateTime     @default(now())
  resolvedAt  DateTime?

  @@index([reporterId])
  @@index([fileId])
  @@index([status])
  @@map("reports")
}

enum ReportReason {
  COPYRIGHT
  INAPPROPRIATE
  MALWARE
  SPAM
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWING
  RESOLVED
  REJECTED
}

// 배너 광고
model Banner {
  id          String   @id @default(uuid())
  title       String
  imageUrl    String
  link        String?
  position    String   // 'top', 'sidebar', 'bottom'
  order       Int      @default(0)

  validFrom   DateTime
  validUntil  DateTime

  clickCount  Int      @default(0)
  viewCount   Int      @default(0)

  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([position])
  @@index([isActive])
  @@map("banners")
}

// 설정
model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  type      String   // 'string', 'number', 'boolean', 'json'

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}
